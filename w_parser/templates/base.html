{% load static %}

<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>w parser</title>
        {% comment %} <link rel="stylesheet" href="{% static 'css/main.css' %}"> {% endcomment %}
        <link rel="stylesheet" href="{% static 'css/dev/main.css' %}">
    </head>
    <body>
        <div class="wrapper">
            <header class="header section section--full-padding">
                <div class="container">
                    <a class="link" href="{% url 'index' %}">Главная</a>

                    <nav>
                        <ul>
                            <li>
                                <a class="link" href="{% url 'saved_searchs' %}">Сохраненные поиски</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </header>
            <main>
                {% block content %}{% endblock %}
            </main>
            <footer class="section section--full-padding">
                <div class="container">
                    <a class="link link--center"
                       href="https://t.me/webAmoeba"
                       target="_blank">webAmoeba</a>
                </div>
            </footer>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const btn = document.getElementById("save-results");
                if (!btn) return;

                btn.addEventListener("click", () => {
                    const rows = document.querySelectorAll("tbody tr");
                    const products = Array.from(rows).map(row => {
                        const cells = row.querySelectorAll("td");
                        const wbId = parseInt(row.dataset.wbId, 10);
                        if (isNaN(wbId)) {
                            console.error(`Invalid wb_id for row: ${cells[0].innerText.trim()}`);
                            return null;
                        }
                        return {
                            wb_id: wbId,
                            name: cells[0].innerText.trim(),
                            price: parseInt(cells[1].innerText.replace(/\D/g, "")) || 0,
                            discount_price: parseInt(cells[2].innerText.replace(/\D/g, "")) || 0,
                            rating: row.dataset.rating 
                                ? parseFloat(row.dataset.rating.replace(',', '.')) 
                                : null,
                            reviews: parseInt(cells[4].innerText.replace(/\D/g, "")) || 0,
                        };
                    }).filter(product => product !== null);

                    const query = "{{ query|escapejs }}";
                    console.log("Saving products:", products, "Query:", query);

                    fetch("{% url 'save_products' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: JSON.stringify({ query, products }),
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert("✔️ Поиск успешно сохранен в базе.");
                        } else {
                            alert("❌ Ошибка при сохранении: " + data.error);
                        }
                    })
                    .catch(err => {
                        alert("❌ Сбой сети или сервера: " + err);
                    });
                });
            });
        </script>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            const rows   = Array.from(document.querySelectorAll("tbody tr"));
            const prices = rows.map(r =>
              parseInt(r.querySelector("td:nth-child(3)").innerText.replace(/\D/g, ""), 10)
            );
             const maxPrice = prices.length ? Math.max(...prices) : 0;
             const step = Math.ceil(maxPrice / 5);
             const priceBins = [0, step, step*2, step*3, step*4, Infinity];
             const priceLabels = [
               `0–${step}`,
               `${step}–${step*2}`,
               `${step*2}–${step*3}`,
               `${step*3}–${step*4}`,
               `${step*4}+`
             ];


            const priceCounts = priceBins.slice(0, -1).map((_, i) => {
                const min = priceBins[i], max = priceBins[i + 1];
                return prices.filter(p => p >= min && p < max).length;
            });

            const ctx = document.getElementById('priceHistogramCanvas').getContext('2d');
            const priceHistogramChart = new Chart(ctx, {
                type: 'bar',
                data: {
                labels: priceLabels,
                datasets: [{
                    label: 'Количество товаров',
                    data: priceCounts,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
                },
                options: {
                scales: {
                    x: { title: { display: true, text: 'Диапазон цены (₽)' } },
                    y: { title: { display: true, text: 'Число товаров' }, beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
                }
            });

            function refreshPriceHistogram() {
                const newPrices = Array.from(document.querySelectorAll("tbody tr")).map(r =>
                parseInt(r.querySelector("td:nth-child(3)").innerText.replace(/\D/g, ""), 10)
                );

                priceHistogramChart.data.datasets[0].data = priceBins.slice(0, -1).map((_, i) => {
                const min = priceBins[i], max = priceBins[i + 1];
                return newPrices.filter(p => p >= min && p < max).length;
                });
                priceHistogramChart.update();
            }

            document.querySelectorAll('input[name="min_price"], input[name="max_price"], input[name="min_rating"], input[name="min_reviews"], select[name="sort_by"]')
                .forEach(el => el.addEventListener('change', refreshPriceHistogram));
        </script>

    </body>
</html>
