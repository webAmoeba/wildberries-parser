{% load static %}

<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>w parser</title>
        {% comment %} <link rel="stylesheet" href="{% static 'css/main.css' %}"> {% endcomment %}
        <link rel="stylesheet" href="{% static 'css/dev/main.css' %}">
    </head>
    <body>
        <div class="wrapper">
            <header class="section section--full-padding">
                <div class="container">
                    <a class="link" href="{% url 'index' %}">Главная</a>
                </div>
            </header>
            <main>
                {% block content %}{% endblock %}
            </main>
            <footer class="section section--full-padding">
                <div class="container">
                    <a class="link link--center"
                       href="https://t.me/webAmoeba"
                       target="_blank">webAmoeba</a>
                </div>
            </footer>
        </div>

        <script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("save-results");
  if (!btn) return;

  btn.addEventListener("click", () => {
    // 1) Собираем данные из таблицы
    const rows = document.querySelectorAll("tbody tr");
    const products = Array.from(rows).map(row => {
      const cells = row.querySelectorAll("td");
      const wbId = parseInt(row.dataset.wbId, 10);
      // Проверяем, что wb_id корректный
      if (isNaN(wbId)) {
        console.error(`Invalid wb_id for row: ${cells[0].innerText.trim()}`);
        return null; // Пропускаем некорректные строки
      }
      return {
        wb_id: wbId,
        name: cells[0].innerText.trim(),
        price: parseInt(cells[1].innerText.replace(/\D/g, "")) || 0,
        discount_price: parseInt(cells[2].innerText.replace(/\D/g, "")) || 0,
        rating: parseFloat(cells[3].innerText) || null,
        reviews: parseInt(cells[4].innerText.replace(/\D/g, "")) || 0,
      };
    }).filter(product => product !== null); // Убираем null значения

    console.log("Saving products:", products);

    // 2) Отправляем на сервер
    fetch("{% url 'save_products' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}", // Добавляем CSRF-токен
      },
      body: JSON.stringify(products),
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("✔️ Товары успешно сохранены в базе.");
      } else {
        alert("❌ Ошибка при сохранении: " + data.error);
      }
    })
    .catch(err => {
      alert("❌ Сбой сети или сервера: " + err);
    });
  });
});
        </script>



    </body>
</html>
